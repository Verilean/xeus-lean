/***************************************************************************
* Copyright (c) 2025, xeus-lean contributors
*
* Distributed under the terms of the Apache Software License 2.0.
*
* The full license is in the file LICENSE, distributed with this software.
****************************************************************************/

#include <iostream>
#include <memory>

#include "xeus/xkernel.hpp"
#include "xeus/xkernel_configuration.hpp"
#include "xeus-zmq/xserver_zmq.hpp"
#include "xeus-zmq/xzmq_context.hpp"

#include "xeus-lean/xinterpreter.hpp"

int main(int argc, char* argv[]) {
    // Parse command line arguments for connection file
    std::string connection_file = "connection.json";

    // Look for -f flag
    for (int i = 1; i < argc - 1; ++i) {
        if (std::string(argv[i]) == "-f") {
            connection_file = argv[i + 1];
            break;
        }
    }

    // Load the kernel configuration
    xeus::xconfiguration config = xeus::load_configuration(connection_file);

    // Create ZMQ context
    auto context = xeus::make_zmq_context();

    // Create the interpreter instance
    auto interpreter = std::make_unique<xeus_lean::interpreter>();

    std::cout << "Starting Lean kernel..." << std::endl;
    std::cout << "Connection file: " << connection_file << std::endl;

    // Create and start the kernel using default server
    xeus::xkernel kernel(config,
                        xeus::get_user_name(),
                        std::move(context),
                        std::move(interpreter),
                        xeus::make_xserver_default);

    kernel.start();

    return 0;
}
